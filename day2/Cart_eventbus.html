<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="./lib/react.development.js"></script>
    <script src="./lib/react-dom.development.js"></script>
    <script src="./lib/babel.min.js"></script>
    <script>
        class EventBus {
            constructor() {
                this.handlerSlot = {};
            }
            // ç›‘å¬ä¸€ä¸ª eventName æŒ‡å®šçš„äº‹ä»¶
            $on(eventName, handler){
                let handlers = this.handlerSlot[eventName];
                if (!handlers) {
                    handlers = [];
                    this.handlerSlot[eventName] = handlers;
                }
                handlers.push(handler);
                return {
                    cancel() {
                        let position = handlers.indexOf(handler);
                        handlers.splice(position, 1);
                    }
                }
            }
            // å¹¿æ’­ä¸€ä¸ªeventName æŒ‡å®šçš„äº‹ä»¶
            $emit(eventName, data) {
                let handlers = this.handlerSlot[eventName];
                if (handlers) {
                    for (let handler of handlers) {
                        handler(data);
                    }
                }
            }
        }
    </script>
</head>
<body>
<div id="app"></div>
<script type="text/babel">
    // å£°æ˜ä¸€ä¸ªå…¨å±€ eventbus å¯¹è±¡
    let eventBus = new EventBus();
    class ProductList extends React.Component {
        constructor(props) {
            super(props);
            this.state = {
                products: [
                    {id: '111', name: 'é¼ æ ‡', price: 100},
                    {id: '222', name: 'é”®ç›˜', price: 200},
                ]
            }
        }
        render() {
            const {products} = this.state;
            const lis = products.map((product) => {
                return (
                    <li key={product.id}>
                        {product.name}
                        <button onClick={ () => { eventBus.$emit('add_product_cart', product) } }>
                            æ·»åŠ è´­ç‰©è½¦
                        </button>
                    </li>
                );
            });
            return (
                <div style={ {border: 'solid 5px green', margin: '5px'} }>
                    äº§å“åˆ—è¡¨:
                    <ul>
                        {lis}
                    </ul>
                </div>
            );
        }
    }
    class Cart extends React.Component {
        constructor(props) {
            super(props);
            this.state = { cart: {items: []} };
            this.handler = eventBus.$on('add_product_cart', (product) => { //  ç›‘å¬ add_product_cart äº‹ä»¶
                this.addToCart(product);
            })
        }
        addToCart(product) {
            let exist = false;
            const items = this.state.cart.items.map((item) => {
                if (item.id === product.id) {
                    exist = true;
                    return {...item, count: item.count + 1};
                } else {
                    return item;
                }
            });
            if (!exist) {
                items.push({ ...product, count: 1 });
            }
            this.setState({ cart: {items} } )
        }
        componentWillUnmount() {  // å½“ç»„ä»¶è¢«å¸è½½çš„æ—¶å€™ å–æ¶ˆ eventbus äº‹ä»¶ç›‘å¬
            this.handler.cancel();
        }
        render() {
            const lis = this.state.cart.items.map((item) => {
                return (
                    <li key={item.id}>
                        {item.name}, å•ä»·: {item.price}, æ•°é‡: {item.count}
                    </li>
                );
            });
            return (
                <div style={ {border: 'solid 5px red', margin: '5px'} }>
                    è´­ç‰©è½¦:
                    <ul>
                        {lis}
                    </ul>
                </div>
            );
        }
    }
    class Shop extends React.Component {
        render() {
            return (
                <div style={ {border: 'solid 5px blue', margin: '5px'} }>
                    å•†åº—:
                    <ProductList/>
                    <Cart/>
                </div>
            );
        }
    }
    ReactDOM.render(<Shop/>, document.getElementById('app'))


    // let eventBus = new EventBus();
    //
    // eventBus.$on('æˆ‘é¥¿äº†', function (data) {
    //     console.log('æˆ‘è¦åƒ' + data);
    // });
    //
    // eventBus.$on('æˆ‘é¥¿äº†', function (data) {
    //     console.log('æˆ‘ä¸å–œæ¬¢åƒ' + data);
    // });
    //
    //
    // eventBus.$emit('æˆ‘é¥¿äº†', 'ğŸš');
    //
    // eventBus.$emit('æˆ‘é¥¿äº†', 'ğŸŒ');

</script>
</body>
</html>
